---
- name: Install and Configure Nginx and NTP
  hosts: loadbalancer
  become: yes

  tasks:
    - name: Install Nginx
      apt:
        name: nginx
        state: latest

    - name: Delete nginx.conf if it exists
      file:
        path: /etc/nginx/nginx.conf
        state: absent
      ignore_errors: yes

    - name: Create nginx.conf
      file:
        path: /etc/nginx/nginx.conf
        state: touch

    - name: Update nginx.conf
      blockinfile:
        path: /etc/nginx/nginx.conf
        marker: "# {mark} ANSIBLE MANAGED BLOCK - DO NOT EDIT"
        insertafter: EOF
        block: |
          events {
              worker_connections 768;
              # multi_accept on;
          }

          stream {
              upstream k8s_servers_http {
                  server 133.14.14.10:6443;
                  server 133.14.14.11:6443;
                  server 133.14.14.12:6443;
              }
              server {
                  listen 6443;
                  proxy_pass k8s_servers_http;
              }
          }

